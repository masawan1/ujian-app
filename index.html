import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, query, addDoc, updateDoc, deleteDoc, orderBy } from 'firebase/firestore';

// --- Konfigurasi dan Konstanta ---
const EXAM_DURATION_SECONDS = 1800;
const EXAM_RESULTS_COLLECTION = 'exam_results';
const QUESTIONS_COLLECTION = 'questions'; // Nama koleksi baru untuk soal

// ========================================================================
// KONFIGURASI FIREBASE PROYEK ANDA SUDAH DIINTEGRASIKAN DI SINI
// ========================================================================
const MY_CUSTOM_FIREBASE_CONFIG = {
    apiKey: "AIzaSyATMc_z-Q2qNsojqsl58AN14hL5Ldf4k3U",
    authDomain: "ujian-online-f9fc2.firebaseapp.com",
    projectId: "ujian-online-f9fc2",
    storageBucket: "ujian-online-f9fc2.firebasestorage.app",
    messagingSenderId: "900820928505",
    appId: "1:900820928505:web:66fc8304c0fbbab6d51f28",
};
// ========================================================================

// --- Fungsi Utilitas Database ---
const useFirebase = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [isAnonymous, setIsAnonymous] = useState(true);

    const finalConfig = MY_CUSTOM_FIREBASE_CONFIG;

    useEffect(() => {
        if (!finalConfig.apiKey) return;

        try {
            const app = initializeApp(finalConfig);
            const firestore = getFirestore(app);
            const authentication = getAuth(app);

            setDb(firestore);
            setAuth(authentication);

            const unsubscribe = onAuthStateChanged(authentication, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    setIsAnonymous(user.isAnonymous);
                    setIsAuthReady(true);
                } else {
                    // Hanya sign in anonymous jika belum ada user
                    if (!authentication.currentUser) {
                        const anonymousUser = await signInAnonymously(authentication);
                        setUserId(anonymousUser.user.uid);
                        setIsAnonymous(true);
                        setIsAuthReady(true);
                    }
                }
            });

            return () => unsubscribe();
        } catch (error) {
            console.error("Error saat inisialisasi Firebase. Pastikan Auth Domain, API Key sudah benar, dan Anonymous Authentication sudah diaktifkan.", error);
            setIsAuthReady(true);
        }
    }, [finalConfig.apiKey]);

    const getResultDocRef = (uid) => {
        return doc(db, EXAM_RESULTS_COLLECTION, uid); 
    };

    return { db, auth, userId, isAuthReady, getResultDocRef, isAnonymous };
};

// --- Komponen Anak: Tampilan Waktu ---
const TimerDisplay = React.memo(({ seconds }) => {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    const colorClass = seconds <= 180 ? 'text-red-600 font-bold' : 'text-gray-700';

    return (
        <div className={`text-xl p-2 rounded-lg bg-white shadow-md ${colorClass} transition duration-300`}>
            <span className="font-mono">
                {minutes.toString().padStart(2, '0')}:{remainingSeconds.toString().padStart(2, '0')}
            </span>
        </div>
    );
});

// --- Komponen Anak: Tampilan Selamat Datang (Diisolasi dengan memo) ---
const WelcomeScreen = React.memo(({ 
    userId, 
    isAuthReady, 
    setAppState, 
    finalResult, 
    isAnonymous, 
    adminEmail, 
    setAdminEmail, 
    adminPassword, 
    setAdminPassword, 
    handleAdminLogin, 
    adminError, 
    isLoading,
    questionsLoading
}) => {
    const canStartExam = isAuthReady && !questionsLoading;
    
    return (
        <div className="flex flex-col items-center justify-center p-8 bg-white rounded-xl shadow-2xl max-w-lg w-full">
            <h1 className="text-4xl font-extrabold text-blue-800 mb-4">Sistem Ujian Online</h1>
            <p className="text-gray-600 mb-6 text-center">
                Selamat datang! Aplikasi ini menyajikan soal pilihan ganda kompleks dengan batasan waktu.
            </p>

            {!(isAuthReady && !questionsLoading) ? (
                <div className="flex items-center space-x-2 p-3 bg-blue-100 text-blue-800 rounded-lg">
                    <svg className="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    <span>{isAuthReady ? 'Memuat Soal...' : 'Mengautentikasi pengguna...'}</span>
                </div>
            ) : (
                <>
                    {/* UID dipastikan ada di sini karena isAuthReady = true */}
                    <p className="text-sm text-gray-500 mb-6">
                        <span className="font-semibold text-gray-700">ID Pengguna (Peserta Anonim):</span> <span className="font-mono break-all">{userId}</span>
                    </p>
                    <button
                        onClick={() => setAppState('exam')}
                        disabled={isLoading}
                        className="w-full py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105 disabled:opacity-50"
                    >
                        Mulai Ujian (30 Menit)
                    </button>
                    {finalResult && (
                        <div className="mt-4 p-4 w-full bg-yellow-50 border-l-4 border-yellow-500 rounded-md">
                            <p className="text-sm text-yellow-700">
                                Anda sudah memiliki hasil ujian terakhir.
                            </p>
                            <p className="text-lg font-bold text-yellow-800">
                                Nilai: {finalResult.percentage}%
                            </p>
                            <button
                                onClick={() => setAppState('results')}
                                className="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium"
                            >
                                Lihat Detail
                            </button>
                        </div>
                    )}
                    
                    {/* Admin Login dengan Email/Password */}
                    {isAnonymous && (
                        <div className="mt-6 pt-4 border-t w-full">
                            <h4 className="text-sm font-bold text-gray-700 mb-2">Akses Admin (Login Permanen)</h4>
                            
                            <input
                                type="email"
                                placeholder="Email Admin"
                                value={adminEmail}
                                onChange={(e) => setAdminEmail(e.target.value)}
                                className="w-full p-2 border border-gray-300 rounded-lg text-sm mb-2 focus:ring-red-500 focus:border-red-500"
                            />
                            <input
                                type="password"
                                placeholder="Password Admin"
                                value={adminPassword}
                                onChange={(e) => setAdminPassword(e.target.value)}
                                className="w-full p-2 border border-gray-300 rounded-lg text-sm mb-2 focus:ring-red-500 focus:border-red-500"
                            />
                            <button
                                onClick={handleAdminLogin}
                                disabled={isLoading}
                                className="w-full py-2 bg-red-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-300 disabled:opacity-50"
                            >
                                {isLoading ? 'Memproses...' : 'Masuk Dashboard Admin'}
                            </button>
                            {adminError && <p className="text-xs text-red-500 mt-1">{adminError}</p>}
                        </div>
                    )}
                </>
            )}
        </div>
    );
});


// --- Komponen Anak: UI Tambah/Edit Soal ---
const QuestionForm = React.memo(({ db, currentQuestion, setEditingQuestion, onSave }) => {
    const isEditing = !!currentQuestion;
    const [questionText, setQuestionText] = useState(currentQuestion ? currentQuestion.text : '');
    const [questionType, setQuestionType] = useState(currentQuestion ? currentQuestion.type : 'single-select');
    const [maxScore, setMaxScore] = useState(currentQuestion ? currentQuestion.maxScore : 5);
    const [order, setOrder] = useState(currentQuestion ? currentQuestion.order || 0 : 0); // Field baru: Order
    const [options, setOptions] = useState(currentQuestion ? currentQuestion.options : [{ id: 'opt1', text: '', isCorrect: false }]);
    const [error, setError] = useState('');

    const generateId = () => Math.random().toString(36).substring(2, 9);

    const handleOptionChange = (index, field, value) => {
        const newOptions = [...options];
        newOptions[index][field] = value;

        // Logika untuk single-select: hanya satu yang boleh benar
        if (questionType === 'single-select' && field === 'isCorrect' && value === true) {
            newOptions.forEach((opt, i) => {
                if (i !== index) opt.isCorrect = false;
            });
        }
        setOptions(newOptions);
    };

    const handleAddOption = () => {
        setOptions([...options, { id: generateId(), text: '', isCorrect: false }]);
    };

    const handleRemoveOption = (index) => {
        setOptions(options.filter((_, i) => i !== index));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');

        if (questionText.trim() === '' || options.length < 2 || maxScore <= 0) {
            setError('Semua kolom wajib diisi dan skor harus lebih dari 0.');
            return;
        }

        const isAnyCorrect = options.some(opt => opt.isCorrect);
        if (!isAnyCorrect) {
            setError('Minimal harus ada satu opsi jawaban yang ditandai sebagai BENAR.');
            return;
        }

        const questionData = {
            text: questionText,
            type: questionType,
            maxScore: Number(maxScore),
            order: Number(order), // Simpan urutan
            options: options.map(opt => ({
                id: opt.id,
                text: opt.text.trim(),
                isCorrect: opt.isCorrect,
            }))
        };
        
        try {
            const qRef = collection(db, QUESTIONS_COLLECTION);
            
            if (isEditing) {
                const docRef = doc(qRef, currentQuestion.id);
                await updateDoc(docRef, questionData);
                onSave('Soal berhasil diperbarui.');
            } else {
                await addDoc(qRef, questionData);
                onSave('Soal baru berhasil ditambahkan.');
            }
        } catch (err) {
            console.error("Error menyimpan soal:", err);
            setError('Gagal menyimpan soal. Pastikan Security Rules Firestore Anda sudah benar untuk Admin.');
        }
    };

    return (
        <div className="p-6 bg-gray-50 rounded-xl border border-blue-200">
            <h3 className="text-2xl font-bold text-blue-700 mb-4">{isEditing ? 'Edit Soal' : 'Tambah Soal Baru'}</h3>
            {error && <div className="p-3 bg-red-100 text-red-700 rounded-lg mb-3 text-sm">{error}</div>}
            
            <form onSubmit={handleSubmit} className="space-y-4">
                {/* Teks Soal */}
                <div>
                    <label className="block text-sm font-medium text-gray-700">Teks Soal</label>
                    <textarea
                        value={questionText}
                        onChange={(e) => setQuestionText(e.target.value)}
                        rows="3"
                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Masukkan teks lengkap soal di sini..."
                    />
                </div>

                {/* Tipe Soal, Skor Maksimal, dan Urutan */}
                <div className="grid grid-cols-3 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Tipe Soal</label>
                        <select
                            value={questionType}
                            onChange={(e) => setQuestionType(e.target.value)}
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                            <option value="single-select">Pilihan Ganda Biasa (Satu Jawaban)</option>
                            <option value="multiple-select">Pilihan Ganda Kompleks (Banyak Jawaban)</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Skor Maksimal</label>
                        <input
                            type="number"
                            min="1"
                            value={maxScore}
                            onChange={(e) => setMaxScore(Number(e.target.value))}
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Urutan Tampil (0 = Awal)</label>
                        <input
                            type="number"
                            min="0"
                            value={order}
                            onChange={(e) => setOrder(Number(e.target.value))}
                            className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                    </div>
                </div>

                {/* Opsi Jawaban */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Opsi Jawaban ({questionType === 'single-select' ? 'Pilih 1 Benar' : 'Pilih > 1 Benar'})</label>
                    <div className="space-y-2">
                        {options.map((opt, index) => (
                            <div key={opt.id} className="flex space-x-2 items-center">
                                <input
                                    type={questionType === 'single-select' ? 'radio' : 'checkbox'}
                                    checked={opt.isCorrect}
                                    onChange={(e) => handleOptionChange(index, 'isCorrect', e.target.checked)}
                                    name={`isCorrect-${currentQuestion ? currentQuestion.id : 'new'}`}
                                    className={`${questionType === 'single-select' ? 'text-red-500' : 'text-green-500'} h-5 w-5`}
                                />
                                <input
                                    type="text"
                                    value={opt.text}
                                    onChange={(e) => handleOptionChange(index, 'text', e.target.value)}
                                    className="flex-grow p-2 border border-gray-300 rounded-md text-sm"
                                    placeholder={`Opsi Jawaban ${index + 1}`}
                                />
                                {options.length > 1 && (
                                    <button
                                        type="button"
                                        onClick={() => handleRemoveOption(index)}
                                        className="text-red-500 hover:text-red-700 p-1 rounded-full bg-white transition"
                                    >
                                        <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                    <button
                        type="button"
                        onClick={handleAddOption}
                        className="mt-3 py-2 px-4 border border-blue-400 text-sm font-medium rounded-lg text-blue-700 bg-blue-100 hover:bg-blue-200 transition"
                    >
                        + Tambah Opsi
                    </button>
                </div>

                {/* Tombol Aksi */}
                <div className="flex justify-end space-x-3">
                    <button
                        type="button"
                        onClick={() => setEditingQuestion(null)}
                        className="py-2 px-4 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition"
                    >
                        Batal
                    </button>
                    <button
                        type="submit"
                        className="py-2 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition"
                    >
                        {isEditing ? 'Simpan Perubahan' : 'Tambah Soal'}
                    </button>
                </div>
            </form>
        </div>
    );
});


// --- Komponen Anak: Question Management (Diisolasi) ---
const QuestionManagement = React.memo(({ db, questions, setQuestions, fetchQuestions, questionsFetchError, userId, questionsLoading }) => {
    const [editingQuestion, setEditingQuestion] = useState(null);
    const [adminMessage, setAdminMessage] = useState({ text: '', type: '' });

    const handleSave = (message) => {
        setAdminMessage({ text: message, type: 'success' });
        setEditingQuestion(null);
        fetchQuestions();
        setTimeout(() => setAdminMessage({ text: '', type: '' }), 5000);
    };

    const handleDelete = async (questionId) => {
        if (!window.confirm("Apakah Anda yakin ingin menghapus soal ini?")) return;
        
        try {
            const docRef = doc(db, QUESTIONS_COLLECTION, questionId);
            await deleteDoc(docRef);
            setAdminMessage({ text: 'Soal berhasil dihapus.', type: 'success' });
            fetchQuestions();
        } catch (error) {
            console.error("Error menghapus soal:", error);
            setAdminMessage({ text: 'Gagal menghapus soal. Cek izin Admin di Security Rules.', type: 'error' });
        }
    };

    if (questionsFetchError) {
         return (
            <div className="p-6 bg-red-100 border-l-4 border-red-500 rounded-lg shadow-md">
                <h3 className="text-xl font-bold text-red-700 mb-2">üö® Error Izin Soal</h3>
                <p className="text-sm text-red-600 mb-3">
                    Gagal mengambil daftar soal. Ini adalah masalah **Firebase Security Rules** di koleksi `questions`.
                </p>
                <p className="text-sm text-red-600 font-semibold mb-3">
                    UID Admin Anda saat ini: <span className="font-mono bg-white p-1 rounded select-all">{userId}</span>
                </p>
                <p className="text-sm text-red-600">
                    Silakan pastikan aturan `match /questions/{questionId}` mengizinkan **Admin UID** Anda (`{userId}`) untuk **membaca, membuat, mengedit, dan menghapus** data (CRUD).
                </p>
            </div>
        );
    }
    
    // START FIX: Tampilkan spinner saat loading
    if (questionsLoading) {
         return (
             <div className="flex items-center justify-center h-64">
                <svg className="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                <span className="ml-3 text-lg text-gray-700">Memuat data soal...</span>
            </div>
         );
    }
    // END FIX

    if (editingQuestion) {
        return (
            <QuestionForm
                db={db}
                currentQuestion={editingQuestion}
                setEditingQuestion={setEditingQuestion}
                onSave={handleSave}
            />
        );
    }

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center pb-3 border-b">
                <h3 className="text-2xl font-bold text-gray-800">Daftar Soal ({questions.length})</h3>
                <button
                    onClick={() => setEditingQuestion({ maxScore: 5, order: questions.length, options: [{ id: 'opt1', text: '', isCorrect: false }] })}
                    className="py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition"
                >
                    + Tambah Soal Baru
                </button>
            </div>
            
            {adminMessage.text && (
                <div className={`p-3 rounded-lg text-sm ${adminMessage.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                    {adminMessage.text}
                </div>
            )}

            {questions.length === 0 ? (
                <p className="text-gray-500">Belum ada soal ujian. Silakan tambah soal pertama Anda.</p>
            ) : (
                <div className="space-y-4">
                    {questions.map((q, index) => (
                        <div key={q.id} className="p-4 bg-white rounded-lg shadow border border-gray-200 hover:shadow-lg transition">
                            <div className="flex justify-between items-start">
                                <p className="text-base font-semibold text-gray-800">
                                    {q.order !== undefined ? `[${q.order}] ` : ''} {index + 1}. {q.text} 
                                </p>
                                <div className="flex space-x-2">
                                    <button
                                        onClick={() => setEditingQuestion(q)}
                                        className="text-yellow-600 hover:text-yellow-800 text-sm font-medium"
                                    >
                                        Edit
                                    </button>
                                    <button
                                        onClick={() => handleDelete(q.id)}
                                        className="text-red-600 hover:text-red-800 text-sm font-medium"
                                    >
                                        Hapus
                                    </button>
                                </div>
                            </div>
                            <div className="mt-2 text-sm text-gray-600">
                                <p>Tipe: <span className="font-medium capitalize">{q.type.replace('-', ' ')}</span> | Skor Maks: <span className="font-medium">{q.maxScore}</span></p>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
});

// --- Helper untuk Konversi Data ke CSV ---
const convertToCSV = (data) => {
    if (!data || data.length === 0) return '';

    // Mengidentifikasi semua kunci yang mungkin ada (termasuk keys di objek answers)
    const allKeys = new Set();
    data.forEach(item => {
        Object.keys(item).forEach(key => allKeys.add(key));
        if (item.answers) {
            Object.keys(item.answers).forEach(qId => {
                allKeys.add(`Jawaban Soal ${qId}`);
            });
        }
    });

    const standardHeaders = ['id', 'userId', 'percentage', 'rawScore', 'totalMaxScore', 'totalQuestions', 'timestamp'];
    const dynamicHeaders = Array.from(allKeys).filter(key => !standardHeaders.includes(key) && key !== 'answers').sort();
    
    // Urutan header CSV
    const headers = [...standardHeaders, ...dynamicHeaders];

    const rows = data.map(row => {
        const rowData = {};
        headers.forEach(header => {
            if (standardHeaders.includes(header)) {
                rowData[header] = row[header];
            } else if (header.startsWith('Jawaban Soal')) {
                const qId = header.replace('Jawaban Soal ', '');
                // Mengonversi array jawaban (untuk multiple select) menjadi string
                rowData[header] = row.answers && row.answers[qId] ? row.answers[qId].join(';') : '';
            }
        });
        return headers.map(header => JSON.stringify(rowData[header] || '')).join(',');
    });

    return [headers.join(','), ...rows].join('\n');
};

const downloadFile = (data, filename, type) => {
    const blob = new Blob([data], { type: type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};


// --- Komponen Anak: Tampilan Admin Dashboard (Diisolasi dengan memo) ---
const AdminDashboard = React.memo(({ db, userId, handleAdminLogout, isAdmin, questions, fetchQuestions, totalMaxScore, questionsFetchError, questionsLoading }) => {
    const [examResults, setExamResults] = useState([]);
    const [adminLoading, setAdminLoading] = useState(true);
    const [adminFetchError, setAdminFetchError] = useState(null);
    const [view, setView] = useState('results'); // 'results' atau 'questions'
    const [searchTerm, setSearchTerm] = useState(''); // State baru untuk pencarian

    const EXAM_RESULTS_COLLECTION = 'exam_results'; 

    useEffect(() => {
        if (!db || !userId || view !== 'results') return;

        const fetchAllResults = async () => {
            setAdminLoading(true);
            setAdminFetchError(null);
            try {
                // Dapatkan referensi collection 'exam_results'
                const resultsCollectionRef = collection(db, EXAM_RESULTS_COLLECTION);
                const querySnapshot = await getDocs(query(resultsCollectionRef));
                
                const resultsData = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                resultsData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                setExamResults(resultsData);
                setAdminLoading(false);

            } catch (error) {
                console.error("Gagal mengambil data admin. CEK SECURITY RULES ANDA UNTUK AKSES KOLEKSI.", error);
                setAdminFetchError("Gagal mengambil data. Pastikan ID Pengguna Admin Anda diizinkan membaca seluruh koleksi `exam_results` di Firebase Security Rules.");
                setAdminLoading(false);
            }
        };
        
        // Hanya fetch jika ini admin dan view adalah results
        if (isAdmin && view === 'results') {
            fetchAllResults();
        } else if (!isAdmin) {
             setAdminLoading(false);
             setAdminFetchError("Anda tidak terotentikasi sebagai Admin yang terdaftar di Security Rules.");
        }
    }, [db, userId, isAdmin, view]);

    // Logika Pencarian
    const filteredResults = useMemo(() => {
        if (!searchTerm) return examResults;
        const lowerCaseSearch = searchTerm.toLowerCase();

        return examResults.filter(result => {
            // Filter berdasarkan ID Peserta
            if (result.userId && result.userId.toLowerCase().includes(lowerCaseSearch)) {
                return true;
            }
            // Filter berdasarkan Skor
            if (result.percentage && result.percentage.toString().includes(lowerCaseSearch)) {
                return true;
            }
            // Filter berdasarkan Status Kelulusan
            const status = result.percentage >= 70 ? 'lulus' : 'gagal';
            if (status.includes(lowerCaseSearch)) {
                return true;
            }
            return false;
        });
    }, [examResults, searchTerm]);

    // --- Handler Ekspor Data ---
    const handleExport = (format) => {
        const timestamp = new Date().toISOString().slice(0, 10);
        let dataToExport;
        let filename;
        let mimeType;

        if (format === 'csv') {
            dataToExport = convertToCSV(filteredResults);
            filename = `hasil_ujian_${timestamp}.csv`;
            mimeType = 'text/csv;charset=utf-8;';
        } else if (format === 'json') {
            dataToExport = JSON.stringify(filteredResults, null, 2);
            filename = `hasil_ujian_${timestamp}.json`;
            mimeType = 'application/json';
        } else {
            return;
        }

        downloadFile(dataToExport, filename, mimeType);
    };


    const ResultTable = () => (
        <>
            {/* Input Pencarian */}
            <div className="flex space-x-3 mb-4">
                <input
                    type="text"
                    placeholder="Cari berdasarkan ID Peserta, Nilai, atau Status..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500"
                />
                <div className="flex space-x-2">
                    <button 
                        onClick={() => handleExport('csv')}
                        className="py-2 px-4 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-300 text-sm whitespace-nowrap"
                        disabled={filteredResults.length === 0}
                    >
                        Export CSV
                    </button>
                    <button 
                        onClick={() => handleExport('json')}
                        className="py-2 px-4 bg-purple-400 text-white font-semibold rounded-lg shadow-md hover:bg-purple-500 transition duration-300 text-sm whitespace-nowrap"
                        disabled={filteredResults.length === 0}
                    >
                        Export JSON
                    </button>
                </div>
            </div>

            <p className="text-sm text-gray-600 mb-6">
                Menampilkan {filteredResults.length} dari {examResults.length} Hasil Ujian (Skor Maksimal Soal Aktif: {totalMaxScore}).
            </p>

            {adminLoading ? (
                <div className="flex items-center justify-center h-64">
                    <svg className="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    <span className="ml-3 text-lg text-gray-700">Memuat hasil ujian...</span>
                </div>
            ) : filteredResults.length === 0 && !adminFetchError ? (
                <p className="text-gray-500">Tidak ada hasil yang cocok dengan pencarian Anda.</p>
            ) : (
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Peserta</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skor (%)</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skor Mentah</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {filteredResults.map((result) => (
                                <tr key={result.id} className="hover:bg-gray-50 transition duration-150">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate max-w-xs">{result.id}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-blue-600">{result.percentage}%</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{result.rawScore} / {result.totalMaxScore}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-xs text-gray-500">
                                        {new Date(result.timestamp).toLocaleDateString()}
                                        <br />
                                        {new Date(result.timestamp).toLocaleTimeString()}
                                    </td>
                                    <td className="px-6 py-4 whitespace-nowrap">
                                        <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${result.percentage >= 70 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                            {result.percentage >= 70 ? 'LULUS' : 'GAGAL'}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </>
    );
    
    return (
        <div className="w-full max-w-6xl p-6 bg-white rounded-xl shadow-2xl">
            {/* BLOK INSTRUKSI PENTING UNTUK UID (Fixed jika ada Error) */}
            {(adminFetchError || questionsFetchError) && (
                 <div className="fixed top-0 left-0 right-0 z-50 p-4 shadow-xl bg-red-600 text-white">
                    <p className="font-bold text-lg mb-1">
                        üö® PERHATIAN: AKSES DITOLAK! UID Admin Permanen Anda: 
                        <span className="font-mono bg-white text-red-700 p-1 rounded ml-2 select-all">
                            {userId || "Memuat..."}
                        </span>
                    </p>
                    <p className="text-sm mt-1">
                        <strong>Langkah Wajib:</strong> Salin UID di atas dan **ganti** `UID_ANDA_DI_SINI` di **Firestore Security Rules** Anda (di kedua koleksi: `exam_results` dan `questions`), lalu **Publish** aturan tersebut.
                    </p>
                 </div>
            )}
            
            {/* Konten Dashboard Utama (Tambahkan padding jika ada error fixed di atas) */}
            <div className={`${(adminFetchError || questionsFetchError) ? 'mt-16' : ''}`}> 
                {/* Header Dashboard */}
                <div className="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 className="text-3xl font-extrabold text-red-700">Admin Dashboard</h2>
                    <button
                        onClick={handleAdminLogout}
                        className="py-2 px-4 bg-gray-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-gray-600 transition"
                    >
                        Keluar Admin
                    </button>
                </div>
                
                {/* BLOK INFORMASI (Tampil jika tidak ada Error) */}
                {!(adminFetchError || questionsFetchError) && (
                    <div className="w-full p-4 rounded-lg shadow-inner bg-yellow-100 border border-yellow-500 mb-6">
                        <p className="font-bold text-lg mb-1 text-gray-800">
                            UID Admin (Permanen): 
                            <span className="font-mono bg-white p-1 rounded ml-2 text-red-600 break-all select-all">
                                {userId || "Memuat..."}
                            </span>
                        </p>
                        <p className="text-sm text-gray-700 mt-2">
                            UID di atas adalah ID Admin permanen Anda. Pastikan ID ini sudah terdaftar di Aturan Keamanan Firestore untuk melihat semua hasil dan mengelola soal.
                        </p>
                    </div>
                )}
                {/* AKHIR BLOK INFORMASI */}

                {/* Navigasi View Admin */}
                <div className="mb-6 flex space-x-2 border-b-2 border-gray-300">
                    <button
                        onClick={() => setView('results')}
                        className={`py-2 px-4 font-semibold transition ${view === 'results' ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-500 hover:text-gray-700'}`}
                    >
                        Data Hasil Ujian
                    </button>
                    <button
                        onClick={() => setView('questions')}
                        className={`py-2 px-4 font-semibold transition ${view === 'questions' ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-500 hover:text-gray-700'}`}
                    >
                        Kelola Soal
                    </button>
                </div>

                {/* Konten Dashboard */}
                {view === 'results' && <ResultTable />}
                {view === 'questions' && (
                    <QuestionManagement 
                        db={db} 
                        userId={userId} // Tambahkan userId untuk menampilkan error di QM
                        questions={questions} 
                        setQuestions={setQuestions}
                        fetchQuestions={fetchQuestions}
                        questionsFetchError={questionsFetchError} // Teruskan error ke QM
                        questionsLoading={questionsLoading} // Teruskan loading state
                    />
                )}
            </div>
        </div>
    );
});

// --- Komponen Utama Aplikasi ---

const App = () => {
    const { db, auth, userId, isAuthReady, getResultDocRef, isAnonymous } = useFirebase();

    const [appState, setAppState] = useState('welcome'); // 'welcome', 'exam', 'results', 'admin'
    const [answers, setAnswers] = useState({});
    const [timeLeft, setTimeLeft] = useState(EXAM_DURATION_SECONDS);
    const [finalResult, setFinalResult] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const [isSubmitting, setIsSubmitting] = useState(false);
    
    // State Soal dari Database
    const [questions, setQuestions] = useState([]); 
    const [questionsLoading, setQuestionsLoading] = useState(true);
    const [questionsFetchError, setQuestionsFetchError] = useState(null); // State baru untuk error soal

    // State untuk Admin Login
    const [adminEmail, setAdminEmail] = useState(''); 
    const [adminPassword, setAdminPassword] = useState('');
    const [adminError, setAdminError] = useState('');
    
    const isAdmin = !isAnonymous && userId === auth?.currentUser?.uid;

    const totalMaxScore = useMemo(() => {
        return questions.reduce((sum, q) => sum + q.maxScore, 0);
    }, [questions]);
    
    // --- Ambil Soal dari Firestore (dengan OrderBy) ---
    const fetchQuestions = useCallback(() => {
        if (!db) return;
        setQuestionsLoading(true);
        setQuestionsFetchError(null); // Reset error sebelum fetch
        
        const questionsRef = collection(db, QUESTIONS_COLLECTION);
        const questionsQuery = query(questionsRef); 

        const unsubscribe = onSnapshot(questionsQuery, (snapshot) => {
            let fetchedQuestions = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            // Lakukan pengurutan di memori setelah mendapatkan data (lebih aman)
            fetchedQuestions.sort((a, b) => (a.order || 0) - (b.order || 0));

            setQuestions(fetchedQuestions);
            setQuestionsLoading(false);
            setQuestionsFetchError(null); // Sukses

            if (fetchedQuestions.length === 0 && appState === 'exam') {
                // window.alert("Peringatan: Tidak ada soal ditemukan. Hubungi Admin.");
                setAppState('welcome');
            }
        }, (error) => {
            console.error("Gagal mengambil soal. Cek Security Rules koleksi 'questions'.", error);
            setQuestionsFetchError(error.message); // Set error message
            setQuestionsLoading(false);
        });

        return () => unsubscribe();
    }, [db, appState]);


    useEffect(() => {
        if (db) {
            fetchQuestions();
        }
    }, [db, fetchQuestions]);

    // --- Efek Timer ---
    useEffect(() => {
        if (appState !== 'exam') return;

        const timer = setInterval(() => {
            setTimeLeft(prevTime => {
                if (prevTime <= 1) {
                    clearInterval(timer);
                    handleSubmitExam(true); // Kirim otomatis saat waktu habis
                    return 0;
                }
                return prevTime - 1;
            });
        }, 1000);

        return () => clearInterval(timer);
    }, [appState]);

    // --- Listener Hasil Ujian ---
    useEffect(() => {
        if (!db || !userId || !isAuthReady || appState !== 'welcome') return;

        const resultRef = getResultDocRef(userId);

        const unsubscribe = onSnapshot(resultRef, (docSnap) => {
            if (docSnap.exists() && appState === 'welcome') {
                setFinalResult(docSnap.data());
            }
        }, (error) => {
            console.error("Error mengambil hasil ujian:", error);
        });

        return () => unsubscribe();
    }, [db, userId, isAuthReady, appState, getResultDocRef]);


    // --- Handler Penilaian ---
    const handleAnswerChange = (questionId, optionId, type) => {
        setAnswers(prevAnswers => {
            const currentAnswers = prevAnswers[questionId] || [];

            if (type === 'single-select') {
                return { ...prevAnswers, [questionId]: [optionId] };
            } else if (type === 'multiple-select') {
                if (currentAnswers.includes(optionId)) {
                    return {
                        ...prevAnswers,
                        [questionId]: currentAnswers.filter(id => id !== optionId)
                    };
                } else {
                    return {
                        ...prevAnswers,
                        [questionId]: [...currentAnswers, optionId]
                    };
                }
            }
            return prevAnswers;
        });
    };

    const calculateScore = (submittedAnswers) => {
        let score = 0;
        let totalAnswered = 0;

        // Gunakan state questions yang dinamis
        questions.forEach(q => {
            const userAnswerIds = submittedAnswers[q.id] || [];
            if (userAnswerIds.length > 0) {
                totalAnswered++;
            }

            if (q.type === 'single-select') {
                // Logika penilaian single-select
                if (userAnswerIds[0] === q.options.find(opt => opt.isCorrect)?.id) {
                    score += q.maxScore;
                }
            } else if (q.type === 'multiple-select') {
                let currentQScore = 0;
                const correctOptionIds = q.options.filter(opt => opt.isCorrect).map(opt => opt.id);

                userAnswerIds.forEach(selectedId => {
                    if (correctOptionIds.includes(selectedId)) {
                        currentQScore += 1;
                    } else {
                        currentQScore -= 0.5; // Penalti
                    }
                });

                currentQScore = Math.max(0, currentQScore);
                currentQScore = Math.min(q.maxScore, currentQScore);
                score += currentQScore;
            }
        });

        const finalScorePercentage = (score / totalMaxScore) * 100;

        return {
            rawScore: Math.round(score * 10) / 10,
            percentage: Math.round(finalScorePercentage),
            totalQuestions: questions.length,
            totalAnswered: totalAnswered,
            totalMaxScore: totalMaxScore,
            timestamp: new Date().toISOString(),
        };
    };

    const handleSubmitExam = async (isTimeUp = false) => {
        if (isSubmitting) return;
        if (questions.length === 0) {
             // window.alert("Tidak ada soal untuk disubmit.");
             setAppState('welcome');
             return;
        }

        setIsSubmitting(true);
        setIsLoading(true);

        const results = calculateScore(answers);
        setFinalResult(results);

        if (db && userId) {
            try {
                const resultDocRef = getResultDocRef(userId);
                const dataToSave = {
                    ...results,
                    userId: userId,
                    answers: answers,
                    totalQuestions: questions.length, // Simpan jumlah soal saat submission
                };
                await setDoc(resultDocRef, dataToSave);
                console.log("Hasil ujian berhasil disimpan ke Firestore.");
            } catch (error) {
                console.error("Gagal menyimpan hasil ke Firestore. Cek Security Rules Anda.", error);
            }
        }

        setAppState('results');
        setIsSubmitting(false);
        setIsLoading(false);
    };
    
    // --- Handler Admin Login dengan Email/Password ---
    const handleAdminLogin = async () => {
        setAdminError('');
        if (!adminEmail || !adminPassword || !auth) {
            setAdminError('Email dan password wajib diisi.');
            return;
        }

        try {
            setIsLoading(true);
            await signInWithEmailAndPassword(auth, adminEmail, adminPassword);
            
            setAppState('admin');
            setAdminEmail('');
            setAdminPassword('');
            
        } catch (error) {
            console.error("Error Admin Login:", error);
            setAdminError('Login gagal. Cek kembali Email/Password Anda dan pastikan metode Email/Password sudah diaktifkan di Firebase.');
        } finally {
            setIsLoading(false);
        }
    };
    
    const handleAdminLogout = async () => {
        if (auth) {
            await signOut(auth);
            setAppState('welcome');
            setAnswers({});
            setFinalResult(null);
            window.location.reload(); 
        }
    };


    // --- Komponen Anak: Tampilan Soal Ujian ---
    const ExamScreen = () => (
        <div className="flex flex-col items-center w-full max-w-4xl p-4 md:p-8">
            <div className="fixed top-0 right-0 m-4 z-10">
                <TimerDisplay seconds={timeLeft} />
            </div>

            <h2 className="text-3xl font-bold text-gray-800 mt-2 mb-8 border-b-2 border-blue-500 pb-2 w-full text-center">
                Lembar Jawaban Ujian
            </h2>
            
            {questionsLoading && (
                <div className="text-center p-10 text-lg text-gray-600">Memuat soal dari database...</div>
            )}
            
            {questions.length === 0 && !questionsLoading && (
                <div className="text-center p-10 text-xl text-red-600 bg-red-50 border border-red-300 rounded-xl">
                    ‚ö†Ô∏è Tidak ada soal ujian yang ditemukan. Hubungi Administrator.
                </div>
            )}


            <form onSubmit={(e) => { e.preventDefault(); handleSubmitExam(); }} className="space-y-10 w-full">
                {questions.map((q, index) => (
                    <div key={q.id} className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <p className="text-sm font-semibold text-blue-600 mb-2">Soal No. {index + 1} ({q.maxScore} Poin Maks.)</p>
                        <p className="text-lg font-medium text-gray-800 mb-4">{q.text}</p>

                        <div className="space-y-3">
                            {q.options.map(opt => {
                                const isChecked = answers[q.id]?.includes(opt.id);
                                return (
                                    <label
                                        key={opt.id}
                                        className={`flex items-start p-3 rounded-lg cursor-pointer transition duration-200 ${
                                            isChecked
                                                ? 'bg-blue-50 border-blue-400 shadow-inner'
                                                : 'bg-gray-50 hover:bg-gray-100 border-gray-300'
                                        } border`}
                                    >
                                        <input
                                            type={q.type === 'single-select' ? 'radio' : 'checkbox'}
                                            name={`question-${q.id}`}
                                            checked={isChecked || false}
                                            onChange={() => handleAnswerChange(q.id, opt.id, q.type)}
                                            className={`mt-1.5 h-5 w-5 ${q.type === 'single-select' ? 'text-blue-600' : 'text-green-600 rounded'} focus:ring-blue-500`}
                                        />
                                        <span className="ml-3 text-base text-gray-700 select-none">
                                            {opt.text}
                                        </span>
                                    </label>
                                );
                            })}
                        </div>
                    </div>
                ))}

                <div className="mt-12 sticky bottom-0 bg-white p-4 rounded-t-xl shadow-2xl border-t">
                    <button
                        type="submit"
                        disabled={isSubmitting || isLoading || questions.length === 0}
                        className="w-full py-3 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-xl hover:bg-red-700 transition duration-300 disabled:opacity-50"
                    >
                        {isSubmitting || isLoading ? 'Mengirim Jawaban...' : 'Selesai & Kirim Jawaban'}
                    </button>
                    <div className="text-xs text-gray-500 mt-2 text-center flex items-center justify-center space-x-2">
                        <span>Waktu tersisa:</span>
                        <TimerDisplay seconds={timeLeft} />
                    </div>
                </div>
            </form>
        </div>
    );

    // --- Komponen Anak: Tampilan Hasil (Diisolasi dengan memo) ---
    const ResultScreen = React.memo(({ finalResult, setAppState, userId }) => {
        if (!finalResult) {
            return (
                <div className="flex flex-col items-center justify-center p-8 bg-white rounded-xl shadow-2xl max-w-lg w-full">
                    <h1 className="text-4xl font-extrabold text-blue-800 mb-4">Hasil Ujian</h1>
                    <p className="text-gray-600 mb-6">Memuat hasil atau hasil tidak ditemukan.</p>
                    <button
                        onClick={() => setAppState('welcome')}
                        className="py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition"
                    >
                        Kembali
                    </button>
                </div>
            );
        }

        const StatCard = ({ title, value, color }) => (
            <div className="flex flex-col items-center p-5 rounded-xl shadow-md bg-white border border-gray-100">
                <div className={`h-12 w-12 rounded-full ${color} mb-3 flex items-center justify-center text-white text-xl font-bold`}>
                    <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                </div>
                <p className="text-sm font-medium text-gray-500">{title}</p>
                <p className="text-2xl font-bold text-gray-800 mt-1">{value}</p>
            </div>
        );

        const isPassed = finalResult.percentage >= 70;
        const resultText = isPassed ? 'SELAMAT, ANDA LULUS!' : 'MOHON COBA LAGI';
        const resultColor = isPassed ? 'text-green-700 bg-green-100 border-green-500' : 'text-red-700 bg-red-100 border-red-500';

        return (
            <div className="flex flex-col items-center w-full max-w-3xl p-6 md:p-10 bg-white rounded-xl shadow-2xl">
                <h1 className="text-4xl font-extrabold text-gray-800 mb-6">Hasil Ujian Anda</h1>

                <div className={`w-full p-6 text-center rounded-xl border-4 ${resultColor} mb-8 shadow-inner`}>
                    <p className="text-lg font-semibold">Status:</p>
                    <p className="text-5xl font-black mt-1">{resultText}</p>
                </div>

                <div className="w-full grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <StatCard title="Nilai Akhir" value={`${finalResult.percentage}%`} color="bg-blue-500" />
                    <StatCard title="Skor Mentah" value={`${finalResult.rawScore} / ${finalResult.totalMaxScore}`} color="bg-yellow-500" />
                    <StatCard title="Total Soal" value={`${finalResult.totalQuestions}`} color="bg-indigo-500" />
                    <StatCard title="ID Peserta" value={userId} color="bg-gray-500" />
                </div>

                <div className="w-full mt-4 p-4 bg-gray-50 rounded-lg border">
                    <h3 className="text-xl font-bold text-gray-700 mb-3">Rekap Jawaban Ujian</h3>
                    <p className="text-sm text-gray-500 mb-4">
                        Data ini telah tersimpan di *database* Anda dengan ID: <span className="font-mono text-gray-700">{userId}</span>
                    </p>
                    <pre className="w-full text-xs bg-gray-100 p-3 rounded-md overflow-x-auto border">
                        {JSON.stringify(finalResult.answers, null, 2)}
                    </pre>
                </div>

                <button
                    onClick={() => {
                        setAppState('welcome');
                    }}
                    className="mt-8 py-3 px-8 bg-blue-600 text-white font-semibold rounded-lg shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105"
                >
                    Kembali ke Beranda
                </button>
            </div>
        );
    });

    // --- Komponen Utama: App ---

    let content;
    if (appState === 'welcome') {
        content = (
            <WelcomeScreen
                userId={userId}
                isAuthReady={isAuthReady}
                setAppState={setAppState}
                finalResult={finalResult}
                isAnonymous={isAnonymous}
                adminEmail={adminEmail}
                setAdminEmail={setAdminEmail}
                adminPassword={adminPassword}
                setAdminPassword={setAdminPassword}
                handleAdminLogin={handleAdminLogin}
                adminError={adminError}
                isLoading={isLoading}
                questionsLoading={questionsLoading}
            />
        );
    } else if (appState === 'exam') {
        content = <ExamScreen />;
    } else if (appState === 'results') {
        content = (
            <ResultScreen 
                finalResult={finalResult} 
                setAppState={setAppState} 
                userId={userId} 
            />
        );
    } else if (appState === 'admin') {
        content = (
            <AdminDashboard
                db={db}
                userId={userId}
                handleAdminLogout={handleAdminLogout}
                isAdmin={!isAnonymous}
                questions={questions}
                setQuestions={setQuestions}
                fetchQuestions={fetchQuestions}
                totalMaxScore={totalMaxScore}
                questionsFetchError={questionsFetchError} // Melewatkan error
                questionsLoading={questionsLoading} // Melewatkan loading state
            />
        );
    }

    return (
        <div className="min-h-screen bg-gray-100 flex justify-center items-start pt-10 pb-20 font-inter">
            {content}
            {isLoading && (
                <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
                    <div className="flex items-center space-x-3 bg-white p-4 rounded-lg shadow-xl">
                        <svg className="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span className="text-lg font-semibold text-gray-700">Memproses...</span>
                    </div>
                </div>
            )}
        </div>
    );
};

export default App;
