<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - Ujian Online</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .card { background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 6px 18px rgba(16,24,40,0.06); }
    .btn { padding: .5rem .75rem; border-radius: .5rem; font-weight: 600; }
    .btn-primary { background:#4f46e5; color:white; }
    .btn-danger { background:#ef4444; color:white; }
    .input { width:100%; padding:.5rem; border-radius:.5rem; border:1px solid #e5e7eb; }
    table th, table td { padding:.5rem; border-bottom:1px solid #eef2ff; text-align:left; }
    .nav-btn.active { background:#4f46e5; color:white; }
  </style>
</head>
<body class="bg-indigo-50 min-h-screen p-6 font-sans">

  <div class="max-w-5xl mx-auto">
    <h1 class="text-2xl font-bold text-indigo-700 mb-6">Dashboard Admin â€” Ujian Online</h1>

    <!-- LOGIN -->
    <div id="loginCard" class="card max-w-md mx-auto mb-6">
      <h2 class="font-semibold text-lg mb-3">Login Admin</h2>
      <input id="adminEmail" class="input mb-2" placeholder="Email admin" type="email"/>
      <input id="adminPass" class="input mb-3" placeholder="Password" type="password"/>
      <div class="flex gap-3">
        <button id="btnLogin" class="btn btn-primary flex-1">Masuk</button>
        <button id="btnLogout" class="btn hidden">Keluar</button>
      </div>
      <p id="loginMsg" class="text-sm text-red-500 mt-2 hidden"></p>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="card hidden">
      <div class="flex items-center justify-between mb-4">
        <div class="flex gap-2">
          <button class="btn nav-btn active" data-target="soalPanel">Kelola Soal</button>
          <button class="btn nav-btn" data-target="pesertaPanel">Peserta Didik</button>
          <button class="btn nav-btn" data-target="hasilPanel">Hasil Nilai</button>
        </div>
        <div id="adminInfo" class="text-sm text-gray-600"></div>
      </div>

      <!-- PANEL SOAL -->
      <div id="soalPanel">
        <h2 class="text-lg font-semibold text-indigo-700 mb-3">Kelola Soal</h2>
        <div class="mb-4">
          <input id="qText" class="input mb-2" placeholder="Tulis pertanyaan..." />
          <div id="optsWrap" class="space-y-2 mb-2">
            <input class="input opt" placeholder="Opsi A" />
            <input class="input opt" placeholder="Opsi B" />
            <input class="input opt" placeholder="Opsi C" />
            <input class="input opt" placeholder="Opsi D" />
          </div>
          <label class="block text-sm mb-1">Jawaban benar</label>
          <select id="correctIdx" class="input mb-3">
            <option value="0">Opsi A</option>
            <option value="1">Opsi B</option>
            <option value="2">Opsi C</option>
            <option value="3">Opsi D</option>
          </select>
          <div class="flex gap-3">
            <button id="btnSaveQ" class="btn btn-primary">Tambah Soal</button>
            <button id="btnClear" class="btn">Bersihkan</button>
          </div>
        </div>
        <div>
          <h3 class="font-medium mb-2">Daftar Soal</h3>
          <table class="w-full bg-white">
            <thead><tr><th class="w-3/4">Pertanyaan</th><th>Aksi</th></tr></thead>
            <tbody id="qList"></tbody>
          </table>
        </div>
      </div>

      <!-- PANEL PESERTA -->
      <div id="pesertaPanel" class="hidden">
        <h2 class="text-lg font-semibold text-indigo-700 mb-3">Kelola Peserta Didik</h2>
        <div class="mb-4">
          <input id="studentName" class="input mb-2" placeholder="Nama siswa" />
          <input id="studentEmail" class="input mb-2" placeholder="Email siswa" />
          <div class="flex gap-3">
            <button id="btnAddStudent" class="btn btn-primary">Tambah Peserta</button>
          </div>
        </div>
        <table class="w-full bg-white">
          <thead><tr><th>Nama</th><th>Email</th><th>Aksi</th></tr></thead>
          <tbody id="studentList"></tbody>
        </table>
      </div>

      <!-- PANEL HASIL -->
      <div id="hasilPanel" class="hidden">
        <h2 class="text-lg font-semibold text-indigo-700 mb-3">Hasil Nilai Siswa</h2>
        <div class="flex gap-2 mb-3">
          <button id="btnExport" class="btn btn-primary">Export ke CSV</button>
          <button id="btnRefreshResults" class="btn">Refresh</button>
        </div>
        <table class="w-full bg-white">
          <thead><tr><th>Nama</th><th>Email</th><th>Skor</th><th>Tanggal</th></tr></thead>
          <tbody id="hasilList"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    // gunakan firebaseConfig.js yang mengekspor { app, db, auth }
    import { app, db, auth } from './firebaseConfig.js';
    import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { collection, getDocs, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const ADMIN_UID = "kGAaNL6vPcWKiwzQ3nc71jhHFMx2";

    const loginCard = document.getElementById('loginCard');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const adminPanel = document.getElementById('adminPanel');
    const adminInfo = document.getElementById('adminInfo');
    const loginMsg = document.getElementById('loginMsg');
    const navBtns = document.querySelectorAll('.nav-btn');

    // NAV handling: show/hide panels and call loader for hasil
    navBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        navBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('soalPanel').classList.add('hidden');
        document.getElementById('pesertaPanel').classList.add('hidden');
        document.getElementById('hasilPanel').classList.add('hidden');
        document.getElementById(btn.dataset.target).classList.remove('hidden');

        // when hasil panel shown, refresh results
        if (btn.dataset.target === 'hasilPanel') {
          loadResults();
        }
        if (btn.dataset.target === 'pesertaPanel') {
          loadStudents();
        }
        if (btn.dataset.target === 'soalPanel') {
          loadQuestions();
        }
      });
    });

    function showError(msg, err) {
      console.error(msg, err);
      alert(msg + (err ? "\n" + (err.message || err) : ""));
    }

    onAuthStateChanged(auth, user => {
      if (user && user.uid === ADMIN_UID) {
        loginCard.classList.add('hidden');
        adminPanel.classList.remove('hidden');
        adminInfo.textContent = `Login sebagai: ${user.email}`;
        btnLogout.classList.remove('hidden');
        // initial load for the active panel
        loadQuestions();
      } else {
        loginCard.classList.remove('hidden');
        adminPanel.classList.add('hidden');
      }
    });

    btnLogin.addEventListener('click', async () => {
      const email = document.getElementById('adminEmail').value;
      const pass = document.getElementById('adminPass').value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) { showError("Login gagal", err); }
    });

    btnLogout.addEventListener('click', async () => { await signOut(auth); });

    // ================== SOAL ==================
    const qText = document.getElementById('qText');
    const optsWrap = document.getElementById('optsWrap');
    const correctIdx = document.getElementById('correctIdx');
    const btnSaveQ = document.getElementById('btnSaveQ');
    const btnClear = document.getElementById('btnClear');
    const qList = document.getElementById('qList');

    async function loadQuestions() {
      try {
        qList.innerHTML = "<tr><td colspan='2'>Memuat...</td></tr>";
        const snap = await getDocs(collection(db, 'questions'));
        qList.innerHTML = "";
        snap.forEach(docSnap => {
          const q = docSnap.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(q.text)}</td>
            <td>
              <button class='btn btn-primary text-xs' data-id='${docSnap.id}' data-action='edit'>Edit</button>
              <button class='btn btn-danger text-xs' data-id='${docSnap.id}' data-action='delete'>Hapus</button>
            </td>`;
          qList.appendChild(tr);
        });

        qList.querySelectorAll('button').forEach(btn=>{
          btn.onclick = async()=>{
            const id = btn.dataset.id;
            const action = btn.dataset.action;
            if(action==="delete"){
              if(!confirm("Hapus soal ini?")) return;
              try { await deleteDoc(doc(db,"questions",id)); loadQuestions(); }
              catch(err){ showError('Gagal menghapus soal', err); }
            } else if(action==="edit"){
              // fetch doc
              try {
                const snaps = await getDocs(collection(db,'questions'));
                const found = snaps.docs.find(s=>s.id===id);
                if(!found) return alert('Soal tidak ditemukan');
                const data = found.data();
                qText.value = data.text||'';
                const inputs = optsWrap.querySelectorAll('.opt');
                (data.options||[]).forEach((v,i)=>{ if(inputs[i]) inputs[i].value = v; });
                correctIdx.value = data.correctIndex ?? 0;
                // set up update by delete+add or updateDoc (we used updateDoc before but need doc ref)
                // For simplicity here we'll delete then add on save (or you can implement updateDoc)
                // Save id to a temp attribute
                btnSaveQ.dataset.editing = id;
                btnSaveQ.textContent = 'Perbarui Soal';
              } catch(err){ showError('Gagal load soal untuk edit', err); }
            }
          };
        });
      } catch(err){ showError('Gagal memuat soal', err); }
    }

    btnSaveQ.onclick = async()=>{
      try {
        const text = qText.value.trim();
        const options = Array.from(optsWrap.querySelectorAll(".opt")).map(i=>i.value.trim());
        const correct = parseInt(correctIdx.value);
        if(!text || options.some(o=>!o)) return alert("Lengkapi semua bidang");
        const editingId = btnSaveQ.dataset.editing || null;
        if(editingId){
          // update existing doc
          await updateDoc(doc(db,'questions',editingId), { text, options, correctIndex: correct });
          delete btnSaveQ.dataset.editing;
          btnSaveQ.textContent = 'Tambah Soal';
          alert('Soal diperbarui');
        } else {
          await addDoc(collection(db,"questions"),{text,options,correctIndex:correct});
          alert("Soal ditambahkan");
        }
        qText.value=''; optsWrap.querySelectorAll('.opt').forEach(i=>i.value=''); correctIdx.value='0';
        loadQuestions();
      } catch(err){ showError('Gagal menyimpan soal', err); }
    };

    btnClear.onclick = ()=>{ qText.value=""; optsWrap.querySelectorAll('.opt').forEach(i=>i.value=""); correctIdx.value='0'; btnSaveQ.textContent='Tambah Soal'; delete btnSaveQ.dataset.editing; };

    // ================== PESERTA ==================
    const studentList = document.getElementById('studentList');
    const btnAddStudent = document.getElementById('btnAddStudent');
    const studentName = document.getElementById('studentName');
    const studentEmail = document.getElementById('studentEmail');

    async function loadStudents() {
      try {
        studentList.innerHTML = "<tr><td colspan='3'>Memuat...</td></tr>";
        const snap = await getDocs(collection(db,'students'));
        studentList.innerHTML = "";
        snap.forEach(d=>{
          const s = d.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${escapeHtml(s.name||'-')}</td><td>${escapeHtml(s.email||'-')}</td>
            <td><button class='btn btn-danger text-xs' data-id='${d.id}'>Hapus</button></td>`;
          studentList.appendChild(tr);
        });
        studentList.querySelectorAll('button').forEach(b=>{
          b.onclick = async()=>{ if(confirm('Hapus peserta?')){ await deleteDoc(doc(db,'students',b.dataset.id)); loadStudents(); } };
        });
      } catch(err){ showError('Gagal memuat peserta', err); }
    }

    btnAddStudent.onclick = async()=>{
      try {
        const name = studentName.value.trim(); const email = studentEmail.value.trim();
        if(!name || !email) return alert("Isi nama & email");
        await addDoc(collection(db,'students'),{name,email});
        studentName.value=''; studentEmail.value='';
        loadStudents();
      } catch(err){ showError('Gagal tambah peserta', err); }
    };

    // ================== HASIL NILAI ==================
    const hasilList = document.getElementById('hasilList');
    const btnExport = document.getElementById('btnExport');
    const btnRefresh = document.getElementById('btnRefreshResults');

    // collection names we try (support older variants)
    const RESULT_COLLECTIONS_TO_TRY = ['exam_results','results','hasil_ujian'];

    function formatDateValue(v){
      if(!v) return '-';
      // Firestore Timestamp
      if(typeof v === 'object' && (v.seconds || v.toDate)) {
        try {
          if(v.toDate) return v.toDate().toLocaleString();
          return new Date(v.seconds * 1000).toLocaleString();
        } catch(e){ return String(v); }
      }
      // ISO string or number
      try { return new Date(v).toLocaleString(); } catch(e){ return String(v); }
    }

    async function findResultsCollection() {
      // pick the first collection that has docs
      for(const name of RESULT_COLLECTIONS_TO_TRY){
        try {
          const snap = await getDocs(collection(db, name));
          if(!snap.empty) return { name, snap };
        } catch(e){
          // ignore permission errors here, will be handled by caller
          console.warn('Error reading collection', name, e);
        }
      }
      // none found: return first name as default (so export will still attempt)
      return { name: RESULT_COLLECTIONS_TO_TRY[0], snap: null };
    }

    async function loadResults(){
      try {
        hasilList.innerHTML = "<tr><td colspan='4'>Memuat...</td></tr>";
        const { name, snap } = await findResultsCollection();
        if(!snap || snap.empty){
          hasilList.innerHTML = "<tr><td colspan='4'>Belum ada hasil ujian.</td></tr>";
          return;
        }
        hasilList.innerHTML = "";
        snap.forEach(d=>{
          const r = d.data();
          // normalize fields - support several schema variants
          const nameField = r.name || r.studentName || r.fullname || '-';
          const emailField = r.email || r.studentEmail || r.uid || '-';
          const scoreField = ('score' in r) ? r.score : (r.percent ?? '-');
          const dateField = formatDateValue(r.date || r.createdAt || r.timestamp);
          hasilList.innerHTML += `<tr><td>${escapeHtml(nameField)}</td><td>${escapeHtml(emailField)}</td><td>${escapeHtml(scoreField)}</td><td>${escapeHtml(dateField)}</td></tr>`;
        });
      } catch(err){
        showError('Gagal memuat hasil ujian â€” cek rules & permission', err);
        hasilList.innerHTML = "<tr><td colspan='4'>Error: tidak dapat memuat hasil (cek console).</td></tr>";
      }
    }

    // Export CSV from the same collection we read
    btnExport.onclick = async () => {
      try {
        const { name, snap } = await findResultsCollection();
        if(!snap || snap.empty){ return alert('Belum ada data untuk diexport.'); }
        let csv = "Nama,Email,Skor,Tanggal\n";
        snap.forEach(d=>{
          const r = d.data();
          const nameField = (r.name || r.studentName || '') .replace(/"/g,'""');
          const emailField = (r.email || r.studentEmail || '') .replace(/"/g,'""');
          const scoreField = ('score' in r) ? r.score : (r.percent ?? '');
          const dateField = formatDateValue(r.date || r.createdAt || r.timestamp) .replace(/"/g,'""');
          csv += `"${nameField}","${emailField}","${scoreField}","${dateField}"\n`;
        });
        const blob = new Blob([csv],{type:"text/csv"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `hasil_ujian_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      } catch(err){
        showError('Gagal export CSV', err);
      }
    };

    btnRefresh.onclick = loadResults;

    // small helper
    function escapeHtml(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // initial: nothing (auth will trigger loads)
  </script>
</body>
</html>
