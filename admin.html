<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - Ujian Online</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .card { background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 6px 18px rgba(16,24,40,0.06); }
    .btn { padding: .5rem .75rem; border-radius: .5rem; font-weight: 600; }
    .btn-primary { background:#4f46e5; color:white; }
    .btn-danger { background:#ef4444; color:white; }
    .input { width:100%; padding:.5rem; border-radius:.5rem; border:1px solid #e5e7eb; }
    table th, table td { padding:.5rem; border-bottom:1px solid #eef2ff; }
  </style>
</head>
<body class="bg-indigo-50 min-h-screen p-6 font-sans">

  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold text-indigo-700 mb-6">Dashboard Admin — Ujian Online</h1>

    <!-- LOGIN -->
    <div id="loginCard" class="card max-w-md mx-auto mb-6">
      <h2 class="font-semibold text-lg mb-3">Login Admin</h2>
      <input id="adminEmail" class="input mb-2" placeholder="Email admin" type="email"/>
      <input id="adminPass" class="input mb-3" placeholder="Password" type="password"/>
      <div class="flex gap-3">
        <button id="btnLogin" class="btn btn-primary flex-1">Masuk</button>
        <button id="btnLogout" class="btn hidden">Keluar</button>
      </div>
      <p id="loginMsg" class="text-sm text-red-500 mt-2 hidden"></p>
    </div>

    <!-- ADMIN PANEL (tersembunyi sampai login & autorizasi) -->
    <div id="adminPanel" class="card hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-indigo-700">Kelola Soal</h2>
        <div id="adminInfo" class="text-sm text-gray-600"></div>
      </div>

      <!-- FORM SOAL -->
      <div class="mb-4">
        <input id="qText" class="input mb-2" placeholder="Tulis pertanyaan..." />
        <div id="optsWrap" class="space-y-2 mb-2">
          <input class="input opt" placeholder="Opsi A" />
          <input class="input opt" placeholder="Opsi B" />
          <input class="input opt" placeholder="Opsi C" />
          <input class="input opt" placeholder="Opsi D" />
        </div>

        <label class="block text-sm mb-1">Jawaban benar</label>
        <select id="correctIdx" class="input mb-3">
          <option value="0">Opsi A</option>
          <option value="1">Opsi B</option>
          <option value="2">Opsi C</option>
          <option value="3">Opsi D</option>
        </select>

        <div class="flex gap-3">
          <button id="btnSaveQ" class="btn btn-primary">Tambah Soal</button>
          <button id="btnClear" class="btn">Bersihkan</button>
        </div>
      </div>

      <!-- LIST SOAL -->
      <div>
        <h3 class="font-medium mb-2">Daftar Soal</h3>
        <table class="w-full bg-white">
          <thead><tr><th class="w-3/4">Pertanyaan</th><th>Aksi</th></tr></thead>
          <tbody id="qList"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    // gunakan firebaseConfig.js yang mengekspor { app, db, auth }
    import { app, db, auth } from './firebaseConfig.js';
    import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { collection, getDocs, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // GANTI dengan UID adminmu (persis sama seperti di Authentication -> Users)
    const ADMIN_UID = "ZcJUyzVhwvUoVemfx84oLs2CdyI2";

    // elemen UI
    const loginCard = document.getElementById('loginCard');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const adminPanel = document.getElementById('adminPanel');
    const adminInfo = document.getElementById('adminInfo');
    const loginMsg = document.getElementById('loginMsg');

    const qText = document.getElementById('qText');
    const optsWrap = document.getElementById('optsWrap');
    const correctIdx = document.getElementById('correctIdx');
    const btnSaveQ = document.getElementById('btnSaveQ');
    const btnClear = document.getElementById('btnClear');
    const qList = document.getElementById('qList');

    let editingId = null; // null => create mode; otherwise update mode

    // helper: tampilkan error
    function showError(msg, err) {
      console.error(msg, err);
      alert(msg + (err ? "\\n\\n" + (err.message || err) : ""));
    }

    // 1) auth state
    onAuthStateChanged(auth, user => {
      if (user) {
        // hanya tampilkan panel kalau UID cocok admin
        if (user.uid === ADMIN_UID) {
          loginCard.classList.add('hidden');
          adminPanel.classList.remove('hidden');
          adminInfo.textContent = `Signed in: ${user.email}`;
          btnLogout.classList.remove('hidden');
          loadQuestions();
        } else {
          // bukan admin
          loginMsg.textContent = "Akun ini bukan admin — akses ditolak.";
          loginMsg.classList.remove('hidden');
          btnLogout.classList.remove('hidden');
          // sign out supaya tidak tetap login
          signOut(auth);
        }
      } else {
        loginCard.classList.remove('hidden');
        adminPanel.classList.add('hidden');
        adminInfo.textContent = "";
        btnLogout.classList.add('hidden');
        loginMsg.classList.add('hidden');
      }
    });

    // 2) login handler
    btnLogin.addEventListener('click', async () => {
      const email = document.getElementById('adminEmail').value.trim();
      const pass  = document.getElementById('adminPass').value.trim();
      if (!email || !pass) return alert('Masukkan email & password admin!');
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        // onAuthStateChanged akan men-trigger UI
      } catch (err) {
        showError("Login gagal:", err);
      }
    });

    btnLogout.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (err) {
        showError("Logout gagal:", err);
      }
    });

    // 3) load questions
    async function loadQuestions() {
      try {
        qList.innerHTML = '<tr><td colspan="2" class="py-2 text-sm text-gray-500">Memuat...</td></tr>';
        const snap = await getDocs(collection(db, 'questions'));
        if (snap.empty) {
          qList.innerHTML = '<tr><td colspan="2" class="py-2 text-sm text-gray-500">Belum ada soal.</td></tr>';
          return;
        }
        qList.innerHTML = '';
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const correctText = (d.options && d.options[d.correctIndex]) ? d.options[d.correctIndex] : '-';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="py-2">${escapeHtml(d.text)}</td>
            <td class="py-2">
              <button data-id="${id}" data-action="edit" class="btn btn-primary mr-2 text-xs">Edit</button>
              <button data-id="${id}" data-action="delete" class="btn btn-danger text-xs">Hapus</button>
            </td>`;
          qList.appendChild(tr);
        });

        // pasang listener aksi (delegation)
        qList.querySelectorAll('button').forEach(btn => {
          btn.onclick = async (e) => {
            const id = e.target.dataset.id;
            const action = e.target.dataset.action;
            if (action === 'delete') {
              if (!confirm('Yakin ingin menghapus soal ini?')) return;
              try {
                await deleteDoc(doc(db, 'questions', id));
                loadQuestions();
              } catch (err) {
                showError('Gagal menghapus soal', err);
              }
            } else if (action === 'edit') {
              // ambil data lengkap dari dok
              try {
                const snapSingle = (await getDocs(collection(db, 'questions'))).docs.find(s => s.id === id);
                // better: use doc/ getDoc, but using getDocs for simplicity
                if (!snapSingle) return alert('Dokumen soal tidak ditemukan');
                const data = snapSingle.data();
                editingId = id;
                qText.value = data.text || '';
                const inputs = optsWrap.querySelectorAll('.opt');
                (data.options || []).forEach((v, i) => {
                  if (inputs[i]) inputs[i].value = v;
                });
                correctIdx.value = data.correctIndex ?? 0;
                btnSaveQ.textContent = 'Perbarui Soal';
              } catch (err) {
                showError('Gagal memuat soal untuk edit', err);
              }
            }
          };
        });
      } catch (err) {
        showError('Gagal memuat daftar soal', err);
      }
    }

    // helper escape
    function escapeHtml(s='') {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // 4) save / update soal
    btnSaveQ.addEventListener('click', async () => {
      const text = qText.value.trim();
      const options = Array.from(optsWrap.querySelectorAll('.opt')).map(i => i.value.trim());
      const correct = parseInt(correctIdx.value || '0');

      if (!text || options.some(o => !o)) return alert('Lengkapi teks soal dan semua opsi');

      try {
        if (editingId) {
          // update
          await updateDoc(doc(db, 'questions', editingId), { text, options, correctIndex: correct });
          editingId = null;
          btnSaveQ.textContent = 'Tambah Soal';
          alert('Soal berhasil diperbarui');
        } else {
          // add
          await addDoc(collection(db, 'questions'), { text, options, correctIndex: correct });
          alert('Soal berhasil ditambahkan');
        }
        // clear & reload
        qText.value = '';
        optsWrap.querySelectorAll('.opt').forEach(i => i.value = '');
        correctIdx.value = '0';
        loadQuestions();
      } catch (err) {
        showError('Gagal menyimpan soal', err);
      }
    });

    btnClear.addEventListener('click', () => {
      editingId = null;
      qText.value = '';
      optsWrap.querySelectorAll('.opt').forEach(i => i.value = '');
      correctIdx.value = '0';
      btnSaveQ.textContent = 'Tambah Soal';
    });

    // initial load (tidak memanggil loadQuestions di sini — tunggu auth)
  </script>
</body>
</html>
